<button 
  id="theme-toggle" 
  class="theme-toggle-button"
  aria-label="切换主题"
  title="切换主题">
  <i data-lucide="sun" class="theme-icon theme-icon-light"></i>
  <i data-lucide="moon" class="theme-icon theme-icon-dark"></i>
</button>

<script>
(function() {
  const ThemeManager = {
    STORAGE_KEY: 'theme-preference',
    THEMES: {
      LIGHT: 'light',
      DARK: 'dark',
      AUTO: 'auto'
    },
    
    init() {
      this.applyTheme();
      this.setupToggle();
      this.watchSystemPreference();
    },
    
    getStoredTheme() {
      return localStorage.getItem(this.STORAGE_KEY) || this.THEMES.AUTO;
    },
    
    setStoredTheme(theme) {
      localStorage.setItem(this.STORAGE_KEY, theme);
    },
    
    getSystemPreference() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches 
        ? this.THEMES.DARK 
        : this.THEMES.LIGHT;
    },
    
    getEffectiveTheme() {
      const stored = this.getStoredTheme();
      if (stored === this.THEMES.AUTO) {
        return this.getSystemPreference();
      }
      return stored;
    },
    
    applyTheme() {
      const theme = this.getEffectiveTheme();
      document.body.classList.remove('theme-light', 'theme-dark');
      document.body.classList.add(`theme-${theme}`);
      
      // 更新图标状态（通过 CSS 类控制显示隐藏，所以这里只负责切换状态类）
      const btn = document.getElementById('theme-toggle');
      if(btn) {
         if (theme === 'dark') {
             btn.classList.add('is-dark');
             btn.classList.remove('is-light');
         } else {
             btn.classList.add('is-light');
             btn.classList.remove('is-dark');
         }
      }
    },
    
    cycleTheme() {
      const current = this.getStoredTheme();
      // 简化逻辑：只在 Light 和 Dark 之间切换，或者 Auto -> Opposite
      let next;
      if (current === this.THEMES.AUTO) {
          next = this.getSystemPreference() === this.THEMES.DARK ? this.THEMES.LIGHT : this.THEMES.DARK;
      } else {
          next = current === this.THEMES.DARK ? this.THEMES.LIGHT : this.THEMES.DARK;
      }
      
      this.setStoredTheme(next);
      this.applyTheme();
    },
    
    setupToggle() {
      const button = document.getElementById('theme-toggle');
      if (button) {
        button.addEventListener('click', () => this.cycleTheme());
      }
    },
    
    watchSystemPreference() {
      if (!window.matchMedia) return;
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (this.getStoredTheme() === this.THEMES.AUTO) {
          this.applyTheme();
        }
      });
    }
  };
  
  ThemeManager.init();
})();
</script>