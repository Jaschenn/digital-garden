---
{"dg-publish":true,"dg-path":"2. 计算机综合/组成原理和操作系统｜干净版/2. 存储系统/2. 存储系统｜数据缓存.md","permalink":"/2//2/2/"}
---


## Cache 和内存

#### Cache 的概念
* 由 Cache 行组成，数据放 Cache 块中，Cache 块大小和主存相同，所有的 Cache 块共同构成 Cache 的数据区.
### Cache 和主存的映射关系
Cache 的数据块 <-> 主存的数据块的对应关系，两者大小相同.
![2. 存储系统｜访存过程_2025-12-11_15-35-08.png](/img/user/attachments/2.%20%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F%EF%BD%9C%E8%AE%BF%E5%AD%98%E8%BF%87%E7%A8%8B_2025-12-11_15-35-08.png)

| 映射方式  | 映射规则                                                                                                                                                                                                                                                                                                                   | 替换策略                                       | 特点                                                              |
| ----- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------ | --------------------------------------------------------------- |
| 直接映射  | 内存物理地址高位是主存块号，在直接映射中，采用模 n 的方式直接把每一个主存块映射到唯一的一个 Cache 块。                                                                                                                                                                                                                                                               | 由于映射是唯一的，所以如果有新的主存块要映射到某个 Cache 块之后，就直接覆盖. | 查找速度快，便宜，但是容易冲突                                                 |
| 组相联映射 | 【常考】n 路组相联=一个组内有 n 个 Cache 块，不是有 n 组。例如，Cache 块一共有 1024 个，采用 8 路组两连，则一共有 128 个组.<br><br>[组号] 的位数由组数决定，128 个组需要 7 位表示<br>即主存的 Cache 块命中了该组之后，放到该组对应的 8 个 Cache 块其中的一个.<br><br>CPU 会拿着一个内存物理地址来问 Cache，在组相联模式下，一个内存物理地址先使用组号（Index）来确定是哪个组，再由 Cache 的硬件同时将该组内的 Cache 块（8 个）对应的 Tag 送入 8 个比较器中比较，若命中则选择一个给 CPU，若不命中则访问主存. | 替换时，是在组内替换，可以基于 LRU 或者是 FIFO 等方式.<br>      | 适中                                                              |
| 全相联映射 | 可能映射到任何一个 Cache 块，只要 Cache 没满，就可以往里放，不会冲突.                                                                                                                                                                                                                                                                             |                                            | 慢、贵（每次来一个地址，需要所有的 Cache 行都参与比较来判断是否命中，有多少行就得需要多少个比较器），关联度最大，无冲突 |

### Cache 物理结构

| Tag  | Flags      | Cache Block |
| ---- | ---------- | ----------- |
| 数据索引 | 修改位、访问位等信息 | 存主存数据的      |


> 注：Group Index、以及 Cache 块号不会实际存储在 Cache 中，通过下标即可定位这些信息，无需存储.
> 以下为实际的 Cache 中存储的内容：
> ![2. 存储系统｜访存过程_2025-12-11_15-54-17.png](/img/user/attachments/2.%20%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F%EF%BD%9C%E8%AE%BF%E5%AD%98%E8%BF%87%E7%A8%8B_2025-12-11_15-54-17.png)

### Cache 写策略

分为两个场景
1. 将数据从主存写入到 Cache 中
2. 将数据从 Cache 写入到主存中。

| 类型                          | 主存->Cache                                                                       | Cache->主存                                                                  |
| --------------------------- | ------------------------------------------------------------------------------- | -------------------------------------------------------------------------- |
| 倾向于操作 Cache<br>（适合频繁写数据的场景） | 写分配法：CPU 要写某个物理地址的时候，先将该地址读入 Cache，然后再写该数据。                                     | 如果是回写法，即 CPU 先把数据写会 Cache，然后才会从 Cache 同步到主存，则需要设置脏位.                       |
| 倾向于操作主存                     | 非写分配法：CPU 要写某个物理地址的时候，如果 Cache 里没有，直接写内存. 只有在 CPU 要读该数据的时候，才会将数据从主存复制到 Cache 中. | 如果是直写法，即 CPU 直接将数据写回主存，无需设置脏位，无需处理 Cache 和主存的数据一致性问题.<br>注：脏位=dirty 位=修改位. |

