<button 
  id="theme-toggle" 
  class="theme-toggle-button"
  aria-label="切换主题"
  title="切换亮色/暗色主题">
  <i data-lucide="sun" class="theme-icon theme-icon-light" style="display: none;"></i>
  <i data-lucide="moon" class="theme-icon theme-icon-dark" style="display: none;"></i>
  <i data-lucide="monitor" class="theme-icon theme-icon-auto" style="display: none;"></i>
</button>

<script>
(function() {
  // 主题管理
  const ThemeManager = {
    STORAGE_KEY: 'theme-preference',
    THEMES: {
      LIGHT: 'light',
      DARK: 'dark',
      AUTO: 'auto'
    },
    
    init() {
      // 立即应用主题（避免闪烁）
      this.applyTheme();
      // 等待 DOM 和图标加载完成后再设置按钮
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          this.setupToggle();
          this.updateButtonIcons();
        });
      } else {
        // 延迟一点确保 lucide 图标已加载
        setTimeout(() => {
          this.setupToggle();
          this.updateButtonIcons();
        }, 100);
      }
      this.watchSystemPreference();
    },
    
    updateButtonIcons() {
      // 确保 lucide 图标被初始化
      if (window.lucide) {
        const button = document.getElementById('theme-toggle');
        if (button) {
          window.lucide.createIcons();
        }
      }
    },
    
    getStoredTheme() {
      try {
        return localStorage.getItem(this.STORAGE_KEY) || this.THEMES.AUTO;
      } catch {
        return this.THEMES.AUTO;
      }
    },
    
    setStoredTheme(theme) {
      try {
        localStorage.setItem(this.STORAGE_KEY, theme);
      } catch {}
    },
    
    getSystemPreference() {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        return this.THEMES.DARK;
      }
      return this.THEMES.LIGHT;
    },
    
    getEffectiveTheme() {
      const stored = this.getStoredTheme();
      if (stored === this.THEMES.AUTO) {
        return this.getSystemPreference();
      }
      return stored;
    },
    
    applyTheme() {
      const theme = this.getEffectiveTheme();
      const body = document.body;
      const html = document.documentElement;
      
      // 移除所有主题类
      body.classList.remove('theme-light', 'theme-dark');
      html.classList.remove('theme-light', 'theme-dark');
      
      // 添加当前主题类
      body.classList.add(`theme-${theme}`);
      html.classList.add(`theme-${theme}`);
      
      // 更新按钮状态
      this.updateButtonState(this.getStoredTheme());
    },
    
    updateButtonState(theme) {
      const button = document.getElementById('theme-toggle');
      if (!button) return;
      
      const icons = {
        light: button.querySelector('.theme-icon-light'),
        dark: button.querySelector('.theme-icon-dark'),
        auto: button.querySelector('.theme-icon-auto')
      };
      
      // 隐藏所有图标
      Object.values(icons).forEach(icon => {
        if (icon) {
          icon.style.display = 'none';
          icon.style.visibility = 'hidden';
        }
      });
      
      // 显示当前主题图标
      if (icons[theme]) {
        icons[theme].style.display = 'inline-block';
        icons[theme].style.visibility = 'visible';
      }
      
      // 更新标题
      const titles = {
        light: '当前：亮色模式（点击切换到暗色）',
        dark: '当前：暗色模式（点击切换到自动）',
        auto: '当前：自动模式（点击切换到亮色）'
      };
      button.title = titles[theme] || '切换主题';
      
      // 重新初始化 lucide 图标
      if (window.lucide) {
        window.lucide.createIcons();
      }
    },
    
    cycleTheme() {
      const current = this.getStoredTheme();
      let next;
      
      if (current === this.THEMES.LIGHT) {
        next = this.THEMES.DARK;
      } else if (current === this.THEMES.DARK) {
        next = this.THEMES.AUTO;
      } else {
        next = this.THEMES.LIGHT;
      }
      
      this.setStoredTheme(next);
      this.applyTheme();
    },
    
    setupToggle() {
      const button = document.getElementById('theme-toggle');
      if (!button) return;
      
      button.addEventListener('click', () => {
        this.cycleTheme();
      });
    },
    
    watchSystemPreference() {
      if (!window.matchMedia) return;
      
      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
      mediaQuery.addEventListener('change', () => {
        // 只有在自动模式下才响应系统变化
        if (this.getStoredTheme() === this.THEMES.AUTO) {
          this.applyTheme();
        }
      });
    }
  };
  
  // 立即初始化主题（避免闪烁）
  ThemeManager.init();
  
  // 确保在 lucide 加载后更新图标
  if (window.lucide) {
    window.lucide.createIcons();
  } else {
    // 监听 lucide 加载
    window.addEventListener('load', () => {
      if (window.lucide) {
        window.lucide.createIcons();
        ThemeManager.updateButtonIcons();
      }
    });
  }
})();
</script>

